# Typedown 实现与文档差距报告

## 执行摘要

本报告基于 `tests_aligned/` 测试套件的分析，对比文档设计与实际实现，识别关键差距。

---

## 1. 关键差距（高优先级）

### 1.1 Reference vs Ref 命名不一致
- **文档**: `Reference[T]`
- **实现**: `Ref["T"]`
- **影响**: API 不一致，用户困惑
- **位置**: `src/typedown/core/base/types.py`
- **建议**: 统一使用 `Reference`，保留 `Ref` 作为别名

### 1.2 多态引用未实现
- **文档**: `Reference["User", "ServiceAccount"]` 允许多种类型
- **实现**: 仅支持单一类型 `Ref["T"]`
- **影响**: 类型系统不完整，某些场景无法表达
- **位置**: `ReferenceMeta` 类
- **建议**: 扩展 `ReferenceMeta` 支持 `target_types: List[str]`

### 1.3 环境变量支持不完整
- **文档**: 定义 `${FILE}`, `${DIR}`, `${ROOT}`, `${FILE_NAME}`, `${TD_ENV}`, `${entity.id}`
- **实现**: 未找到完整的环境变量替换逻辑
- **影响**: 脚本系统功能受限
- **建议**: 在 `script_service.py` 或命令执行时注入环境变量

### 1.4 演进约束检查缺失
- **文档**: 明确的散敛规则（分叉检测、收敛冲突）
- **实现**: 仅有基本的 former 目标存在性检查 (E0343)
- **影响**: 数据完整性风险
- **建议**: 在 L3 Validator 中添加演进图验证

---

## 2. 中等优先级差距

### 2.1 Spec Tag 过滤未实现
- **文档**: `@target(tag="critical")` 示例
- **实现**: 注释标记为 "future enhancement"
- **影响**: Spec 过滤功能受限
- **建议**: 实现 tag 索引和过滤机制

### 2.2 ID 字符集规范不一致
- **文档**: 字母、数字、`_`、`-`
- **实现**: 额外允许 `.`
- **影响**: 规范混乱
- **建议**: 统一文档或实现

### 2.3 演进不可变性未强制执行
- **文档**: 旧实体 Append Only
- **实现**: 无检查
- **影响**: 历史可追溯性风险
- **建议**: 添加警告或配置选项

---

## 3. 低优先级差距

### 3.1 未使用的错误码
- **问题**: 约 9 个错误码定义但未使用
- **建议**: 清理或实现对应检查

### 3.2 文件引用支持有限
- **文档**: `[[path/to/file]]` 文件资源
- **实现**: 基础支持，但未完全集成
- **建议**: 完善文件类型引用的资源管理

---

## 4. 测试覆盖状态

| 模块 | 测试文件 | 覆盖状态 |
|------|----------|----------|
| Model/Entity | 4 个文件 | ✅ 核心功能覆盖 |
| Validation | 4 个文件 | ✅ 三层验证覆盖 |
| Evolution | 2 个文件 | ⚠️ 分叉/收敛待实现 |
| Config | 3 个文件 | ⚠️ 环境变量待验证 |
| References | 3 个文件 | ✅ 核心功能覆盖 |
| Error Codes | 1 个文件 | ⚠️ L4 Spec 需环境 |

---

## 5. 建议修复顺序

### 阶段 1: 立即修复（1-2 天）
1. 统一 `Reference` 命名（添加别名）
2. 完成环境变量支持

### 阶段 2: 短期修复（1-2 周）
3. 实现演进分叉检测
4. 清理未使用错误码

### 阶段 3: 中期改进（2-4 周）
5. 多态引用支持
6. Spec tag 过滤
7. 演进不可变性检查

---

## 6. 验证清单

- [ ] `Reference` 命名统一
- [ ] 多态引用 `Ref[T1, T2]` 可用
- [ ] 环境变量在脚本中可用
- [ ] 演进分叉被检测并报告
- [ ] 所有错误码都有触发路径
- [ ] 文档与实现字符集一致

