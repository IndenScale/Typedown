# 2025-12-16 开发日志

## 架构与规范大幅精化

### 核心决策

1. **创建 `specs/` 目录**：

   - 作为 Typedown 标准的单一真实来源 (Single Source of Truth)，形式化其语法、概念、架构和测试机制。
   - 支持多语言 (中/英)。

2. **核心概念与术语澄清**：

   - 明确区分 `Model` (模型定义) 与 `Entity` (模型实例)。
   - 区分 `Validator` (Pydantic 内部验证) 与 `Specification` (Pytest 业务逻辑验证)。
   - 定义 `Desugar`, `Materialize` 过程。
   - 详细说明了 `Context` (上下文) 的逐层注入与覆盖机制 (Python Code -> Root config.td -> Nested config.td -> Local model block)。

3. **语法与上下文管理优化**：

   - **`model` 块简化**：
     - 移除 `model:<ClassName>` 中的类名冗余，简化为 `model`。
     - 支持在一个 `model` 块中定义多个类。
     - 实现常用 Pydantic 和 Typing 符号的**自动注入**，减少样板代码。
   - **废弃 YAML `imports`**：
     - `config.td` 和其他文档中不再使用 Front Matter 的 `imports`。
     - 统一使用 `config:python` 代码块进行动态上下文配置和外部模型导入。
     - 明确了 `.py` 文件**默认不自动注入**，强调显式导入。

4. **测试机制重构**：

   - **`spec` 块统一为 Pytest 脚本**：
     - 废弃了 YAML 格式的声明式 `spec` 定义。
     - `spec` 块现在直接是 Python 代码，用于编写标准的 Pytest 测试函数。
   - **自动注入 `pytest` 模块和 `session` Fixture**。
   - 引入 `check` 块作为内联断言的语法糖。
   - 利用 `@pytest.mark` 进行测试组织与筛选。

5. **文档归档与新 ADR 记录**：
   - 将所有历史 ADR 文档归档至 `dev-docs/legacy/adr/`，以保留思考过程。
   - 创建 ADR-0009 记录本次设计精化，作为最新架构决策的正式记录。

### 影响

本次大规模的规范精化和架构调整，显著提升了 Typedown 作为标准的清晰度和严谨性，为后续的工具开发和生态系统建设奠定了坚实基础。提升了开发者体验，并确保了多语言支持的一致性。
