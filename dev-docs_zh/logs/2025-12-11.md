# 开发日志: 2025-12-11

## 摘要

今天标志着 Typedown 的一个巨大里程碑。我们成功地将项目从一个基本的解析器演变成了一个功能齐全的 **编译器框架**，能够进行复杂的数据验证、依赖解析、全局约束检查和产物生成。我们完成了所有主要的 MVP 支柱：**P0 (引用)**, **P1 (Schema 验证)**, **P2 (全局约束)**, 和 **P3 (构建产物)**。

## 关键决策与讨论

1. **多语言文档**: 决定维护镜像的 `README.md`/`README_ZH.md` 和 `docs`/`docs_zh`。
2. **强化演变语义**: 明确定义了 `former` (线性) vs `derived_from` (分支) 的规则。记录在 `dev-docs/adr/0004-evolution-semantics.md`。
3. **完善引用机制**: 澄清了 `[[...]]` 查询行为和歧义处理。
4. **CLI/Daemon 架构**: 采用了 **嵌入式工作区库模型** (类 Git/Cargo)。
5. **AST 结构**: 定义了核心数据结构。记录在 `dev-docs/adr/0003-ast-structure-and-caching.md`。
6. **CLI 命令结构**: 正式化 `lint` / `validate` / `build`。记录在 `dev-docs/adr/0005-cli-command-structure.md`。
7. **构建产物策略**: 决定使用 **自包含 Bundle** (`dist/`) 输出。不进行原地源修改。记录在 `dev-docs/adr/0006-build-artifacts-and-expansion.md`。
8. **P2 全局约束架构**: 设计了一个 **Spec/Rule 系统**，其中约束在 `spec:` 块 (Markdown) 中定义，并在 Python (`specs/`) 中实现。采用了 **选择器模式** (`target: "entity:Monster"`) 和 **上下文严重性** (`severity: { default: warning, release: error }`)。记录在 `dev-docs/adr/0007-global-constraints-and-specs.md`。

## 已实现功能

### 核心编译器

- **AST**: 添加 `SpecBlock` 以支持约束定义。
- **Parser**: 实现了 `spec:` 代码块的解析。
- **Resolver**: 实现了高级依赖图（隐式 + 显式）和拓扑排序。
- **Evaluator (P0)**: 实现了引用解析遍历。
- **Validator (P1)**: 实现了 Pydantic 数据验证。
- **SpecRunner (P2)**: 实现了基于 Python 的约束运行器。
  - 从 `specs/` 动态加载检查函数。
  - 实体选择引擎 (`targets`)。
  - 通过 Tags 处理上下文严重性。
  - 标准化 LSP 友好的错误报告。
- **Workspace**: 编排了完整的管道：`Parse -> Resolve Dependencies -> Topo Sort -> (Merge -> Evaluate -> Validate) -> Global Specs`。

### CLI

- **`td validate <path> [--tag T]`**: 运行完整的分析管道，包括按标签过滤的全局 specs。
- **`td build <path> -o <dist> [-f]`**: 生成分发产物 (P3)。
  - 包含严格的 **安全检查** 以防止输出路径冲突和系统路径删除。
  - 生成 `data.json` (“巨型 Blob”) 并复制 `content` 和 `assets`。
- **`td debug parse`**: 可观测性工具。

## 测试与验证

- **P0/P1**: 在 `rpg_campaign` 上验证了引用解析和 Pydantic 验证。
- **P3 (Build)**: 成功生成包含正确 JSON 数据和文件结构的 `dist/`。验证了安全检查能阻止危险操作。
- **P2 (Constraints)**: 在 `use_cases/rpg_campaign/specs/` 中创建了端到端测试用例：
  - `rule_monster_hp_positive` (通过): 验证了成功执行。
  - `rule_item_lightweight` (失败): 验证了正确检测到 `item_sword_iron` (重量 2.0 > 1.5)。
  - **输出**: 验证了标准诊断格式：`Warning: [Rule] ... --> File:Line:Col`。

## 下一步

- **P4 (Lint)**: 实现快速、静态的 `lint` 命令，仅进行语法检查。
- **IDE Extension**: 开发利用 `td` CLI 进行诊断的 VS Code 扩展原型。
- **文档站点**: 使用 Typedown 本身搭建文档项目 (dogfooding)。
